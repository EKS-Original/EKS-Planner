<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EKs Professional Planner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <style>
        :root { --eks-blue: #0D47A1; --eks-dark: #002171; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #eceff1; color: #333; }
        
        /* Activation Screen */
        #activation-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--eks-blue); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .active-box { background: white; padding: 30px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; color: #333; }
        
        /* App UI */
        .header { background: var(--eks-blue); color: white; padding: 15px; text-align: center; }
        .container { padding: 15px; max-width: 800px; margin: auto; }
        .folder-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .folder { background: white; padding: 25px; border-radius: 12px; text-align: center; cursor: pointer; border-bottom: 5px solid var(--eks-blue); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .step-panel { display: none; background: white; padding: 20px; border-radius: 10px; margin-top: 10px; }
        .active { display: block; }

        /* Drawing Workplace */
        #work-place { display: flex; border: 2px solid #ccc; height: 400px; margin: 10px 0; border-radius: 5px; overflow: hidden; }
        #sidebar { width: 60px; background: var(--eks-blue); display: flex; flex-direction: column; align-items: center; padding-top: 10px; gap: 10px; }
        #sidebar button { width: 40px; height: 40px; background: white; border: none; border-radius: 5px; cursor: pointer; }
        canvas { flex-grow: 1; background: #fff; touch-action: none; background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 20px 20px; }

        input, select, .btn { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        .btn { background: var(--eks-blue); color: white; font-weight: bold; border: none; cursor: pointer; }
        .back-btn { background: #607d8b; width: auto; padding: 5px 15px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="activation-screen">
    <div class="active-box">
        <h2 style="color: var(--eks-blue);">EKs LICENSE</h2>
        <p>DEVICE ID:</p>
        <code id="device-id" style="background: #eee; padding: 5px; display: block; margin: 10px 0; word-break: break-all;">Generating...</code>
        <input type="text" id="license-key" placeholder="Enter License Key">
        <button class="btn" onclick="activateLicense()">ACTIVATE</button>
        <p style="font-size: 11px; color: #777;">Send Device ID to Admin for License Key.</p>
    </div>
</div>

<div id="main-app" style="display:none;">
    <div class="header"><h3>EKs FIELD PLANNER</h3></div>
    <div class="container">
        <div id="folder-screen">
            <div class="folder-grid">
                <div class="folder" onclick="startProj('Industrial')">üè≠<br>Industrial</div>
                <div class="folder" onclick="startProj('Residential')">üè†<br>Residential</div>
                <div class="folder" onclick="startProj('Solar')">‚òÄÔ∏è<br>Solar</div>
                <div class="folder" onclick="startProj('Maintenance')">üîß<br>Maintenance</div>
            </div>
        </div>

        <div id="project-form" style="display:none;">
            <button class="btn back-btn" onclick="location.reload()">‚Üê Back</button>
            <h4 id="cat-title" style="color: var(--eks-blue); margin: 5px 0;">Project</h4>

            <div class="step-panel active" id="step1">
                <input type="text" id="pName" placeholder="Project Name">
                <input type="text" id="cName" placeholder="Client Name">
                <button class="btn" onclick="nextStep(2)">Next: Safety ‚Üí</button>
            </div>

            <div class="step-panel" id="step2">
                <div id="safety-checks" style="line-height: 2;"></div>
                <button class="btn" onclick="nextStep(3)">Next: Materials ‚Üí</button>
            </div>

            <div class="step-panel" id="step3">
                <select id="cables"></select>
                <select id="breakers"></select>
                <input type="number" id="qty" placeholder="Quantity">
                <button class="btn" onclick="nextStep(4)">Next: Work Place ‚Üí</button>
            </div>

            <div class="step-panel" id="step4">
                <div id="work-place">
                    <div id="sidebar"><button onclick="ctx.clearRect(0,0,canvas.width,canvas.height)">üóëÔ∏è</button></div>
                    <canvas id="canvas"></canvas>
                </div>
                <button class="btn" style="background: #2e7d32;" onclick="generatePDF()">GENERATE REPORT (PDF)</button>
            </div>
        </div>
    </div>
</div>

<script>
    let devUID = "";
    let currentCat = "";
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    // 1. License System
    async function initDevice() {
        const fp = await FingerprintJS.load();
        const result = await fp.get();
        devUID = result.visitorId.substring(0, 10).toUpperCase();
        document.getElementById('device-id').innerText = devUID;
        if(localStorage.getItem('eks_key') === "EKs-" + devUID.split('').reverse().join('')) showApp();
    }
    initDevice();

    function activateLicense() {
        let key = document.getElementById('license-key').value;
        if(key === "EKs-" + devUID.split('').reverse().join('')) {
            localStorage.setItem('eks_key', key);
            showApp();
        } else { alert("Wrong Key!"); }
    }
    function showApp() { document.getElementById('activation-screen').style.display='none'; document.getElementById('main-app').style.display='block'; }

    // 2. Project Logic
    const cableData = ['1.5mm¬≤', '2.5mm¬≤', '4.0mm¬≤', '6.0mm¬≤', '10mm¬≤', '16mm¬≤', '25mm¬≤', '35mm¬≤', '50mm¬≤', '70mm¬≤', '95mm¬≤', '120mm¬≤', '150mm¬≤', '185mm¬≤', '240mm¬≤'];
    const breakerData = ['6A', '10A', '16A', '20A', '32A', '40A', '63A', '100A MCCB', '160A MCCB', '250A MCCB', '400A MCCB', '630A MCCB', '800A MCCB', '1000A ACB'];

    function startProj(cat) {
        currentCat = cat;
        document.getElementById('folder-screen').style.display='none';
        document.getElementById('project-form').style.display='block';
        document.getElementById('cat-title').innerText = cat + " Project Log";
        
        document.getElementById('cables').innerHTML = cableData.map(c => `<option>${c}</option>`).join('');
        document.getElementById('breakers').innerHTML = breakerData.map(b => `<option>${b}</option>`).join('');
        
        const sft = { 'Industrial': ['LOTO Checked', 'PPE Worn', 'Grounding OK'], 'Residential': ['Main Switch Off', 'Ladder OK'], 'Solar': ['DC Isolated', 'Roof Harness'], 'Maintenance': ['Scheduled cut'] };
        document.getElementById('safety-checks').innerHTML = (sft[cat] || sft['Residential']).map(s => `<label><input type="checkbox"> ${s}</label><br>`).join('');
        
        setTimeout(() => { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }, 100);
    }

    function nextStep(n) {
        document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('step'+n).classList.add('active');
    }

    // 3. Drawing Canvas
    function getPos(e) {
        let rect = canvas.getBoundingClientRect();
        return { x: (e.clientX || e.touches[0].clientX) - rect.left, y: (e.clientY || e.touches[0].clientY) - rect.top };
    }
    canvas.onmousedown = canvas.ontouchstart = (e) => { drawing = true; ctx.beginPath(); let p = getPos(e); ctx.moveTo(p.x, p.y); };
    canvas.onmousemove = canvas.ontouchmove = (e) => { 
        if(!drawing) return; 
        let p = getPos(e); ctx.lineTo(p.x, p.y); ctx.strokeStyle = "#0D47A1"; ctx.lineWidth = 2; ctx.stroke(); 
    };
    canvas.onmouseup = canvas.ontouchend = () => drawing = false;

    // 4. PDF Generation
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(20); doc.setTextColor(13, 71, 161);
        doc.text("EKs FIELD REPORT", 20, 20);
        doc.setFontSize(12); doc.setTextColor(0);
        doc.text(`Category: ${currentCat}`, 20, 35);
        doc.text(`Project: ${document.getElementById('pName').value}`, 20, 45);
        doc.text(`Material: ${document.getElementById('cables').value} / ${document.getElementById('breakers').value}`, 20, 55);
        
        const img = canvas.toDataURL("image/png");
        doc.text("Site Sketch:", 20, 75);
        doc.addImage(img, 'PNG', 20, 80, 160, 80);
        doc.save("EKs_Report.pdf");
    }
</script>
</body>
</html>
