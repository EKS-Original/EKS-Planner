<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EKs Engineering Planner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <style>
        :root { --eks-primary: #1A237E; --eks-secondary: #0D47A1; --eks-accent: #2979FF; --eks-bg: #F0F2F5; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--eks-bg); color: #333; }
        
        /* Security Overlay */
        #activation-screen { position: fixed; inset: 0; background: var(--eks-primary); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .active-box { background: white; padding: 35px; border-radius: 20px; width: 85%; max-width: 380px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }

        /* Main UI */
        .app-header { background: var(--eks-primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .nav-progress { height: 4px; background: #ddd; position: sticky; top: 0; z-index: 100; }
        #progress-fill { height: 100%; width: 0%; background: var(--eks-accent); transition: 0.4s; }

        .container { padding: 15px; max-width: 850px; margin: auto; }
        .dash-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; border-left: 6px solid var(--eks-accent); transition: 0.2s; }
        .dash-card:hover { transform: translateX(5px); }

        /* Planner Modules */
        .planner-module { display: none; background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .module-active { display: block; }
        
        .input-group { margin-bottom: 18px; }
        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px; color: var(--eks-primary); }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1.5px solid #E0E0E0; box-sizing: border-box; font-size: 15px; }
        input:focus { border-color: var(--eks-accent); outline: none; }

        /* Workplace (Drawing) */
        #drawing-zone { display: flex; border: 1.5px solid #ccc; height: 450px; border-radius: 12px; overflow: hidden; margin-top: 15px; }
        #tools { width: 60px; background: var(--eks-primary); display: flex; flex-direction: column; align-items: center; padding: 15px 0; gap: 15px; }
        #tools button { width: 42px; height: 42px; background: rgba(255,255,255,0.15); border: none; border-radius: 10px; color: white; cursor: pointer; }
        #tools button:hover { background: var(--eks-accent); }
        canvas { flex-grow: 1; background: #FFF; touch-action: none; background-image: 
            linear-gradient(45deg, #f9f9f9 25%, transparent 25%), linear-gradient(-45deg, #f9f9f9 25%, transparent 25%), 
            linear-gradient(45deg, transparent 75%, #f9f9f9 75%), linear-gradient(-45deg, transparent 75%, #f9f9f9 75%);
            background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; }

        .action-btn { background: var(--eks-accent); color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: 10px; font-size: 16px; }
    </style>
</head>
<body>

<div id="activation-screen">
    <div class="active-box">
        <h2 style="margin-top:0;">EKs SYSTEM KEY</h2>
        <p style="font-size: 12px; color: #666;">DEVICE IDENTIFIER</p>
        <code id="device-id" style="background: #F0F2F5; padding: 10px; display: block; margin: 10px 0; font-weight: bold; letter-spacing: 1px;">...</code>
        <input type="text" id="license-key" placeholder="Enter System Activation Key">
        <button class="action-btn" onclick="activateLicense()">ACTIVATE PLANNER</button>
    </div>
</div>

<div id="main-app" style="display:none;">
    <div class="nav-progress"><div id="progress-fill"></div></div>
    <div class="app-header">
        <div style="font-size: 18px; font-weight: 800;">EKs <span style="font-weight: 300;">PLANNER</span></div>
        <div id="date-display" style="font-size: 12px;"></div>
    </div>

    <div class="container">
        <div id="dash-view">
            <h3 style="margin-bottom: 20px;">Planning Folders</h3>
            <div class="dash-card" onclick="openModule('Industrial')">
                <strong>INDUSTRIAL HUB</strong><br><small>HVC/LVC Panel Planning, Factory Power</small>
            </div>
            <div class="dash-card" onclick="openModule('Residential')">
                <strong>RESIDENTIAL LOGIC</strong><br><small>Domestic Wiring, Load Distribution</small>
            </div>
            <div class="dash-card" onclick="openModule('Solar')">
                <strong>SOLAR SYSTEM DESIGN</strong><br><small>PV Array & Inverter Integration</small>
            </div>
        </div>

        <div id="module-view" style="display:none;">
            <button onclick="location.reload()" style="background:none; border:none; color:var(--eks-accent); cursor:pointer; margin-bottom:15px; font-weight:bold;">‚Üê BACK TO HUB</button>
            <h2 id="module-title" style="margin: 0 0 20px 0;">Design Mode</h2>

            <div class="planner-module module-active" id="step1">
                <div class="input-group">
                    <label>PROJECT REFERENCE</label>
                    <input type="text" id="projRef" placeholder="e.g. EKS-2026-001">
                </div>
                <div class="input-group">
                    <label>SITE AREA (SQ FT)</label>
                    <input type="number" id="siteArea" placeholder="Enter total area">
                </div>
                <div class="input-group">
                    <label>INCOMING SUPPLY VOLTAGE</label>
                    <select id="voltage">
                        <option>230V Single Phase</option>
                        <option>400V Three Phase</option>
                    </select>
                </div>
                <button class="action-btn" onclick="nextStep(2, 33)">CONFIGURE LOAD SPECS ‚Üí</button>
            </div>

            <div class="planner-module" id="step2">
                <div class="input-group">
                    <label>PRIMARY LOAD TYPE</label>
                    <select id="loadType">
                        <option>Inductive Load (Motors/Compressors)</option>
                        <option>Resistive Load (Heating/Lighting)</option>
                        <option>Mixed Industrial Load</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>MAIN CABLE SIZE (MAX 240MM¬≤)</label>
                    <select id="cableList"></select>
                </div>
                <div class="input-group">
                    <label>PROTECTION BREAKER (MAX 1000A)</label>
                    <select id="breakerList"></select>
                </div>
                <button class="action-btn" onclick="nextStep(3, 66)">GO TO DESIGN WORKPLACE ‚Üí</button>
            </div>

            <div class="planner-module" id="step3">
                <label>SYSTEM SCHEMATIC / SITE LAYOUT</label>
                <div id="drawing-zone">
                    <div id="tools">
                        <button onclick="ctx.clearRect(0,0,canvas.width,canvas.height)">üóëÔ∏è</button>
                        <button onclick="alert('Drawing Mode: Active')">üñãÔ∏è</button>
                    </div>
                    <canvas id="canvas"></canvas>
                </div>
                <button class="action-btn" style="background:#2E7D32;" onclick="generateReport()">EXECUTE & EXPORT PDF</button>
            </div>
        </div>
    </div>
</div>

<script>
    let devUID = "";
    let activeCat = "";
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    // 1. License
    async function initSystem() {
        const fp = await FingerprintJS.load();
        const result = await fp.get();
        devUID = result.visitorId.substring(0, 8).toUpperCase();
        document.getElementById('device-id').innerText = devUID;
        document.getElementById('date-display').innerText = new Date().toDateString();
        
        const storedKey = localStorage.getItem('eks_key');
        if(storedKey === "EKs-" + devUID.split('').reverse().join('')) {
            document.getElementById('activation-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
        }
    }
    initSystem();

    function activateLicense() {
        const key = document.getElementById('license-key').value;
        const correctKey = "EKs-" + devUID.split('').reverse().join('');
        if(key === correctKey) {
            localStorage.setItem('eks_key', key);
            location.reload();
        } else { alert("ACCESS DENIED: Invalid System Key."); }
    }

    // 2. Planning Logic
    const cables = ['1.5mm¬≤', '2.5mm¬≤', '4.0mm¬≤', '6.0mm¬≤', '10mm¬≤', '16mm¬≤', '25mm¬≤', '35mm¬≤', '50mm¬≤', '70mm¬≤', '95mm¬≤', '120mm¬≤', '150mm¬≤', '185mm¬≤', '240mm¬≤'];
    const breakers = ['6A', '10A', '16A', '20A', '32A', '40A', '63A', '100A MCCB', '160A MCCB', '250A MCCB', '400A MCCB', '630A MCCB', '800A MCCB', '1000A ACB'];

    function openModule(cat) {
        activeCat = cat;
        document.getElementById('dash-view').style.display = 'none';
        document.getElementById('module-view').style.display = 'block';
        document.getElementById('module-title').innerText = cat + " System Planner";
        
        document.getElementById('cableList').innerHTML = cables.map(c => `<option>${c}</option>`).join('');
        document.getElementById('breakerList').innerHTML = breakers.map(b => `<option>${b}</option>`).join('');
        
        setTimeout(() => { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }, 200);
    }

    function nextStep(step, progress) {
        document.querySelectorAll('.planner-module').forEach(m => m.classList.remove('module-active'));
        document.getElementById('step'+step).classList.add('module-active');
        document.getElementById('progress-fill').style.width = progress + "%";
    }

    // 3. Canvas
    function getPos(e) {
        let rect = canvas.getBoundingClientRect();
        return { x: (e.clientX || e.touches[0].clientX) - rect.left, y: (e.clientY || e.touches[0].clientY) - rect.top };
    }
    canvas.onmousedown = canvas.ontouchstart = (e) => { drawing = true; ctx.beginPath(); let p = getPos(e); ctx.moveTo(p.x, p.y); };
    canvas.onmousemove = canvas.ontouchmove = (e) => { 
        if(!drawing) return; 
        let p = getPos(e); ctx.lineTo(p.x, p.y); ctx.strokeStyle = "#1A237E"; ctx.lineWidth = 3; ctx.lineCap = "round"; ctx.stroke(); 
    };
    canvas.onmouseup = canvas.ontouchend = () => drawing = false;

    // 4. Export
    function generateReport() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFillColor(26, 35, 126); doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255); doc.setFontSize(22); doc.text("EKs SYSTEM PLANNING DATA", 15, 25);
        
        doc.setTextColor(50); doc.setFontSize(12);
        doc.text(`PLAN CATEGORY: ${activeCat.toUpperCase()}`, 15, 50);
        doc.text(`REFERENCE: ${document.getElementById('projRef').value}`, 15, 60);
        doc.text(`SITE PARAMETERS: ${document.getElementById('siteArea').value} SQ FT / ${document.getElementById('voltage').value}`, 15, 70);
        doc.text(`LOAD SPECS: ${document.getElementById('loadType').value}`, 15, 80);
        doc.text(`HARDWARE: Cable ${document.getElementById('cableList').value} / Breaker ${document.getElementById('breakerList').value}`, 15, 90);
        
        const img = canvas.toDataURL("image/png");
        doc.text("ENGINEERING DESIGN SKETCH:", 15, 110);
        doc.addImage(img, 'PNG', 15, 115, 180, 90);
        
        doc.save(`EKs_Plan_${activeCat}.pdf`);
    }
</script>
</body>
</html>
