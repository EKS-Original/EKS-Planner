<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EKs Professional Planner - Secured</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fingerprintjs2/2.1.0/fingerprint2.min.js"></script>
    <style>
        :root { --eks-blue: #0D47A1; --eks-dark: #002171; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #eceff1; }
        
        /* License Lock Screen */
        #license-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--eks-blue); color: white; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .license-box { background: white; color: #333; padding: 30px; border-radius: 15px; width: 80%; max-width: 400px; text-align: center; }
        
        /* Main UI */
        .header { background: var(--eks-blue); color: white; padding: 20px; text-align: center; }
        .container { padding: 20px; max-width: 900px; margin: auto; }
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; }
        .folder { background: white; border-radius: 12px; padding: 30px 10px; text-align: center; cursor: pointer; border-bottom: 6px solid var(--eks-blue); }
        .step-panel { display: none; background: white; padding: 25px; border-radius: 12px; }
        .active { display: block; }
        
        #work-place { display: flex; border: 2px solid #bbb; height: 450px; background: #fff; border-radius: 8px; }
        #sidebar { width: 60px; background: var(--eks-blue); display: flex; flex-direction: column; align-items: center; padding-top: 15px; gap: 15px; }
        canvas { flex-grow: 1; touch-action: none; background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 20px 20px; }
        input, select, .btn { width: 100%; padding: 14px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        .btn { background: var(--eks-blue); color: white; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="license-screen">
    <div class="license-box">
        <h2 style="color: var(--eks-blue);">EKs LICENSE ACTIVATION</h2>
        <p>Your Device ID:</p>
        <code id="device-id" style="background: #eee; padding: 5px; display: block; margin-bottom: 20px;">Generating...</code>
        <input type="text" id="license-key" placeholder="Enter License Key">
        <button class="btn" onclick="activateLicense()">Activate Now</button>
        <p style="font-size: 12px; color: #666; margin-top: 15px;">Please send your Device ID to EKs Admin to get the License Key.</p>
    </div>
</div>

<div id="main-app" style="display:none;">
    <div class="header"><h1>EKs PROFESSIONAL PLANNER</h1></div>
    <div class="container">
        <div id="folder-screen">
            <h3 style="text-align: center;">Project Categories</h3>
            <div class="folder-grid">
                <div class="folder" onclick="startProject('Residential')">üè†<br>Residential</div>
                <div class="folder" onclick="startProject('Industrial')">üè≠<br>Industrial</div>
                <div class="folder" onclick="startProject('Solar')">‚òÄÔ∏è<br>Solar</div>
                <div class="folder" onclick="startProject('Maintenance')">üîß<br>Maintenance</div>
            </div>
        </div>

        <div id="project-form" style="display:none;">
            <button class="btn" style="width:auto; background:#607d8b;" onclick="location.reload()">‚Üê Back</button>
            <h2 id="current-category">Project</h2>
            
            <div class="step-panel active" id="step1">
                <input type="text" id="projName" placeholder="Project Name">
                <input type="text" id="clientName" placeholder="Client Name">
                <button class="btn" onclick="nextStep(2)">Next: Safety ‚Üí</button>
            </div>
            
            <div class="step-panel" id="step2">
                <div id="safety-list"></div>
                <button class="btn" onclick="nextStep(3)">Next: Materials ‚Üí</button>
            </div>

            <div class="step-panel" id="step3">
                <select id="cableList"></select>
                <select id="breakerList"></select>
                <button class="btn" onclick="nextStep(4)">Next: Work Place ‚Üí</button>
            </div>

            <div class="step-panel" id="step4">
                <div id="work-place">
                    <div id="sidebar">
                        <button onclick="clearCanvas()">üóëÔ∏è</button>
                    </div>
                    <canvas id="canvas"></canvas>
                </div>
                <button class="btn" style="background: #2e7d32;" onclick="generateReport()">Download PDF Report</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- LICENSE LOGIC ---
    let deviceUID = "";

    // Generate Unique Device ID
    window.onload = function() {
        if (window.requestIdleCallback) {
            requestIdleCallback(function () {
                Fingerprint2.get(function (components) {
                    var values = components.map(function (component) { return component.value });
                    deviceUID = Fingerprint2.x64hash128(values.join(''), 31).toUpperCase().substring(0, 12);
                    document.getElementById('device-id').innerText = deviceUID;
                    checkExistingLicense();
                })
            })
        }
    };

    function activateLicense() {
        const inputKey = document.getElementById('license-key').value;
        // Simple Logic: Key = "EKs-" + DeviceID
        const validKey = "EKs-" + deviceUID; 

        if (inputKey === validKey) {
            localStorage.setItem('eks_license_key', inputKey);
            alert("Activation Successful!");
            showApp();
        } else {
            alert("Invalid License Key. Please contact admin.");
        }
    }

    function checkExistingLicense() {
        const storedKey = localStorage.getItem('eks_license_key');
        if (storedKey === "EKs-" + deviceUID) {
            showApp();
        }
    }

    function showApp() {
        document.getElementById('license-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
    }

    // --- APP LOGIC (Previous Drawing & PDF Logic remains same) ---
    // [Note: Keep all the startProject, nextStep, draw, and generateReport functions from the previous response here]
    // (Due to space, I'm keeping the core structure, ensure to paste the drawing/PDF logic from before)
</script>
</body>
</html>
